<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.20.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.20.1/mapbox-gl.css' rel='stylesheet' />
    <script src='//d3js.org/d3.v3.min.js' charset='utf-8'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>

    <div id='map'></div>

    <script>
        var geojson_url = "http://opendata.dc.gov/datasets/35034fcb3b36499c84c94c069ab1a966_27.geojson";
        var whereClause = "?where=OFFENSE+%3D%27ROBBERY%27";

        mapboxgl.accessToken = 'pk.eyJ1Ijoic2d1MiIsImEiOiJjaW5obHQ5d3AwdnljdWtseXlmOGMwNThtIn0.eQMN4cP3iMaw1W_vptvOLQ';
        var layerIDs = [];
        var popup = new mapboxgl.Popup({
            closeOnClick: false,
            closeButton: false
        });

        /*
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v8',
            center: [-103.59179687498357, 40.66995747013945],
            zoom: 3,
        });
        */
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v8',
            center: [-77.034084142948, 38.909671288923],
            zoom: 12
        });

        /*
        var url = 'http://testapps.dcgis.in.dc.gov/ddoe2/earthquakes.geojson';
        var source = new mapboxgl.GeoJSONSource({
            data: url
        });
        */

        //d3.json("http://testapps.dcgis.in.dc.gov/ddoe2/earthquakes.geojson", function (err, geojsondata) {
       
            map.on('load', function () {
                d3.json(geojson_url + whereClause, function (err, geojsondata) {
                // Add a new source from our GeoJSON data and set the
                // 'cluster' option to true.
                
                map.addSource("earthquakes", {
                    type: "geojson",
                    // Point to GeoJSON data. This example visualizes all M1.0+ earthquakes
                    // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
                    //data: "earthquakes.geojson",
                    //data: "https://www.mapbox.com/mapbox-gl-js/assets/earthquakes.geojson",
                    //data: "http://testapps.dcgis.in.dc.gov/ddoe2/earthquakes.geojson",
                    data: geojsondata,
                    cluster: true,
                    clusterMaxZoom: 14, // Max zoom to cluster points on
                    clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
                });
                
                /*
                map.addSource('earthquakes', {
                    'type': 'geojson',
                    'data': geojsondata
                });
                */

                // map.addSource('earthquakes', source);

                //source.setData(url);

                // Use the earthquakes source to create five layers:
                // One for non-clustered markers, three for each cluster category,
                // and one for cluster labels.
                map.addLayer({
                    "id": "non-cluster-markers",
                    "type": "circle",
                    "source": "earthquakes",
                    "paint": {
                        //"circle-color": mag[1],
                        "circle-color": "red",
                        "circle-opacity": 0.75,
                        "circle-radius": 7
                    }
                });

                    layerIDs.push("non-cluster-markers");
                /*
                map.addLayer({
                    "id": "non-cluster-markers",
                    "type": "symbol",
                    "source": "earthquakes",
                    "layout": {
                        "icon-image": "marker-15"
                    }
                });
                */

                // Display the earthquake data in three layers, each filtered to a range of
                // count values. Each range gets a different fill color.
                var lyrs = [
                    [150, '#f28cb1'],
                    [20, '#f1f075'],
                    [0, '#51bbd6']
                ];

                lyrs.forEach(function (layer, i) {
                    map.addLayer({
                        "id": "cluster-" + i,
                        "type": "circle",
                        "source": "earthquakes",
                        "paint": {
                            "circle-color": layer[1],
                            "circle-radius": 18
                        },
                        "filter": i == 0 ?
                            [">=", "point_count", layer[0]] :
                            ["all",
                                [">=", "point_count", layer[0]],
                                ["<", "point_count", lyrs[i - 1][0]]]
                    });                    
                });

                // Add a layer for the clusters' count labels
                map.addLayer({
                    "id": "cluster-count",
                    "type": "symbol",
                    "source": "earthquakes",
                    "layout": {
                        "text-field": "{point_count}",
                        "text-font": [
                                "DIN Offc Pro Medium",
                                "Arial Unicode MS Bold"
                        ],
                        "text-size": 12
                    }
                });

                

                map.on('mousemove', function (e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: layerIDs });
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
                });

                map.on('click', function (e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: layerIDs });
                    //popup.remove();

                    if (!features.length) {
                        popup.remove();
                        return;
                    }

                    if ((features.length == 1) && (!features[0].properties.point_count)) {
                        var feature = features[0];

                        var cont = "Crime Info:<br>" + "Time: " + feature.properties.REPORTDATETIME + "<br>Crime: " + feature.properties.OFFENSE + "<br>Location: " + feature.properties.BLOCKSITEADDRESS;

                        // Use wrapped coordinates to ensure longitude is within (180, -180)
                        var coords = feature.geometry.coordinates;
                        var ll = new mapboxgl.LngLat(coords[0], coords[1]);
                        var wrapped = ll.wrap();

                        popup.setLngLat(wrapped)
                        .setHTML(cont)
                        .addTo(map);
                    }
                });
            });
        });
        
    </script>

</body>
</html>